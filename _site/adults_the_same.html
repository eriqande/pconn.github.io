<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>The Close KinGdom: Adults the same</title>



  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-09-17"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-09-17"/>
  <meta name="article:author" content="Paul Conn"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="The Close KinGdom: Adults the same"/>
  <meta property="og:type" content="article"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="The Close KinGdom"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="The Close KinGdom: Adults the same"/>

  <!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=Matrix population models, 2nd edition;citation_publication_date=2001;citation_publisher=Sinauer;citation_author=H. Caswell"/>
  <meta name="citation_reference" content="citation_title=A note on the delta-method for finding variance formulae;citation_publication_date=1938;citation_volume=1;citation_author=R. Dorfman"/>
  <meta name="citation_reference" content="citation_title=Persistent problems in the construction of matrix population models;citation_publication_date=2019;citation_publisher=Elsevier;citation_volume=406;citation_author=Bruce E Kendall;citation_author=Masami Fujiwara;citation_author=Jasmin Diaz-Lopez;citation_author=Sandra Schneider;citation_author=Jakob Voigt;citation_author=SÃ¶ren Wiesner"/>
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["date","title","author","bibliography","link-citations","csl"]}},"value":[{"type":"character","attributes":{},"value":["2021-09-17"]},{"type":"character","attributes":{},"value":["Adults the same"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name"]}},"value":[{"type":"character","attributes":{},"value":["Paul Conn"]}]}]},{"type":"character","attributes":{},"value":["master_bib.bib"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["biomed-central.csl"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>

  <script type="application/javascript">

    window.headroom_prevent_pin = false;

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');

      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });

      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });

      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>

  <style type="text/css">

  /* Theme (user-documented overrideables for nav appearance) */

  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }

  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }

  .distill-site-nav a:hover {
    color: white;
  }

  @media print {
    .distill-site-nav {
      display: none;
    }
  }

  .distill-site-header {

  }

  .distill-site-footer {

  }


  /* Site Header */

  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }

  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }


  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }

  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }

  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }

  .distill-site-header .logo {
    padding: 0;
  }

  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }

  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }



  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }


  .distill-site-header .nav-toggle {
    display: none;
  }

  .nav-dropdown {
    display: inline-block;
    position: relative;
  }

  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }

  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }

  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown-active {
    display: block;
  }

  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }

  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }

  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }

  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }


  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }

  /* Site Footer */

  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }

  /* Headroom */

  d-title {
    padding-top: 6rem;
  }

  @media print {
    d-title {
      padding-top: 4rem;
    }
  }

  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .headroom--transition {
    transition: all .4s ease-in-out;
  }

  .headroom--unpinned {
    top: -100px;
  }

  .headroom--pinned {
    top: 0;
  }

  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }

  </style>

  <script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
  <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>

  <script type="application/javascript">

  function getMeta(metaName) {
    var metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }

  function offsetURL(url) {
    var offset = getMeta('distill:offset');
    return offset ? offset + '/' + url : url;
  }

  function createFuseIndex() {

    // create fuse index
    var options = {
      keys: [
        { name: 'title', weight: 20 },
        { name: 'categories', weight: 15 },
        { name: 'description', weight: 10 },
        { name: 'contents', weight: 5 },
      ],
      ignoreLocation: true,
      threshold: 0
    };
    var fuse = new window.Fuse([], options);

    // fetch the main search.json
    return fetch(offsetURL('search.json'))
      .then(function(response) {
        if (response.status == 200) {
          return response.json().then(function(json) {
            // index main articles
            json.articles.forEach(function(article) {
              fuse.add(article);
            });
            // download collections and index their articles
            return Promise.all(json.collections.map(function(collection) {
              return fetch(offsetURL(collection)).then(function(response) {
                if (response.status === 200) {
                  return response.json().then(function(articles) {
                    articles.forEach(function(article) {
                      fuse.add(article);
                    });
                  })
                } else {
                  return Promise.reject(
                    new Error('Unexpected status from search index request: ' +
                              response.status)
                  );
                }
              });
            })).then(function() {
              return fuse;
            });
          });

        } else {
          return Promise.reject(
            new Error('Unexpected status from search index request: ' +
                        response.status)
          );
        }
      });
  }

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // get search element (bail if we don't have one)
    var searchEl = window.document.getElementById('distill-search');
    if (!searchEl)
      return;

    createFuseIndex()
      .then(function(fuse) {

        // make search box visible
        searchEl.classList.remove('hidden');

        // initialize autocomplete
        var options = {
          autoselect: true,
          hint: false,
          minLength: 2,
        };
        window.autocomplete(searchEl, options, [{
          source: function(query, callback) {
            const searchOptions = {
              isCaseSensitive: false,
              shouldSort: true,
              minMatchCharLength: 2,
              limit: 10,
            };
            var results = fuse.search(query, searchOptions);
            callback(results
              .map(function(result) { return result.item; })
            );
          },
          templates: {
            suggestion: function(suggestion) {
              var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                : '';
              var html = `
                <div class="search-item">
                  <h3>${suggestion.title}</h3>
                  <div class="search-item-description">
                    ${suggestion.description || ''}
                  </div>
                  <div class="search-item-preview">
                    ${img}
                  </div>
                </div>
              `;
              return html;
            }
          }
        }]).on('autocomplete:selected', function(event, suggestion) {
          window.location.href = offsetURL(suggestion.path);
        });
        // remove inline display style on autocompleter (we want to
        // manage responsive display via css)
        $('.algolia-autocomplete').css("display", "");
      })
      .catch(function(error) {
        console.log(error);
      });

  });

  </script>

  <style type="text/css">

  .nav-search {
    font-size: x-small;
  }

  /* Algolioa Autocomplete */

  .algolia-autocomplete {
    display: inline-block;
    margin-left: 10px;
    vertical-align: sub;
    background-color: white;
    color: black;
    padding: 6px;
    padding-top: 8px;
    padding-bottom: 0;
    border-radius: 6px;
    border: 1px #0F2E3D solid;
    width: 180px;
  }


  @media screen and (max-width: 768px) {
    .distill-site-nav .algolia-autocomplete {
      display: none;
      visibility: hidden;
    }
    .distill-site-nav.responsive .algolia-autocomplete {
      display: inline-block;
      visibility: visible;
    }
    .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
      margin-left: 0;
      width: 400px;
      max-height: 400px;
    }
  }

  .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
    width: 90%;
    outline: none;
    border: none;
  }

  .algolia-autocomplete .aa-hint {
    color: #999;
  }
  .algolia-autocomplete .aa-dropdown-menu {
    width: 550px;
    max-height: 70vh;
    overflow-x: visible;
    overflow-y: scroll;
    padding: 5px;
    margin-top: 3px;
    margin-left: -150px;
    background-color: #fff;
    border-radius: 5px;
    border: 1px solid #999;
    border-top: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
    cursor: pointer;
    padding: 5px 4px;
    border-bottom: 1px solid #eee;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
    border-bottom: none;
    margin-bottom: 2px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
    overflow: hidden;
    font-size: 0.8em;
    line-height: 1.4em;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
    font-size: 1rem;
    margin-block-start: 0;
    margin-block-end: 5px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
    display: inline-block;
    overflow: hidden;
    height: 2.8em;
    width: 80%;
    margin-right: 4%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
    display: inline-block;
    width: 15%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
    height: 3em;
    width: auto;
    display: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
    display: initial;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
    background-color: #eee;
  }
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
    font-weight: bold;
    font-style: normal;
  }

  </style>


  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="site_libs/header-attrs-2.9/header-attrs.js"></script>
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Adults the same","authors":[{"author":"Paul Conn","authorURL":"#","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-09-17T00:00:00.000-07:00","citationText":"Conn, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">The Close KinGdom</a>
<a href="about.html">About</a>
<a href="refs.html">References</a>
</div>
<div class="nav-right">
<a href="estimation.html">Modeling</a>
<a href="design.html">Design</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Examples
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<span class="nav-dropdown-header">Study design</span>
<span class="nav-dropdown-header">Kin finding</span>
<a href="examples_estimation.html">Demography estimation</a>
</div>
</div>
<span class="nav-dropdown-header">Kin finding</span>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Adults the same</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->

</div>

<div class="d-byline">
  
  Paul Conn
  
<br/>2021-09-17
</div>

<div class="d-article">
<p>In this example, we tackle the simple case of a freely mixing population, where adults of each sex reach sexual maturity simultaneously at a known age (maturity schedules can differ for males and females), where adults all have the same expected reproductive output and survival probabilities, and where lethal sampling occurs over a number of years (with one reproductive event per year). This example is chosen because it illustrates some important concepts but is relatively simple compared to those that require age-specificity or real-world complications such as aging error.</p>
<p>As a general point of course, it’s an extremely good idea to write down a life cycle diagram for the species that we’re intrested in modeling (in this case a hypothetical one), as this will help us to write down population dynamics equations and formulate close-kin probabilities. In particular, we need to decide whether or not to use a pre- or post-breeding census, or some variant thereof. For this example, let’s consider a post-breeding census with 4 age classes, juvenile (J), yearling (Y), sub-adult (SA) and adult (A):</p>
<p><img src="images/life_cycle_postbreed.jpg" style="width:100%"></p>
<p>If we were actually modeling recruitment directly, we would need to be careful to model recruitment into the juvenile class as a product of age-specific survival (e.g. <span class="math inline">\(\phi^A\)</span>) and fertility (<span class="math inline">\(f\)</span>). Note also that the subadult class actually survives to be adults prior to breeding, so they need to be taken into account when calculating recruitment. For many close-kin models, there will be an analagous Leslie matrix model <span class="citation" data-cites="Caswell2001">[<a href="#ref-Caswell2001" role="doc-biblioref">1</a>]</span>, and since there are many places where one can go wrong when formulating matrix models <span class="citation" data-cites="KendallEtAl2019">[<a href="#ref-KendallEtAl2019" role="doc-biblioref">2</a>]</span>, one should similarly be careful when specifying close kin probabilities.</p>
<p>For this example, we’ll largely disregard recruitment, as well as juvenile and yearling survival. We’ll also make the simplifying assumption that <span class="math inline">\(\phi^{SA}=\phi^{A}\)</span>. However, using the above diagram, it is clear that when we talk about “breeding adults” we are actually talking about both sub-adults and adults since sub-adults breed at the end of the year (thus our abundance parameter, <span class="math inline">\(N_A\)</span>, represents both adults and subadults).</p>
<p>One advantage of age-homogeneity in recruitment is that we can just deal with “adult” dynamics. This is beneficial because close-kin inference does not provide information about survival of earlier age classes, and to consider a fully age-specific model we’d need to use prior distributions or auxiliary data sets to incorporate fully age-specific dynamics. One possibility is to assume a simple exponential model where the population of “adults” (agin this is both sub-adults and adults with a post-breeding census) at time <span class="math inline">\(t\)</span>, <span class="math inline">\(N_t^A\)</span>, increases (or decreases) exponentially: with rate <span class="math inline">\(r\)</span>:</p>
<p><span class="math display">\[\begin{equation*}
  N_t^A = \left\{ 
  \begin{array}{l} 
     \exp(\nu), &amp; \text{for } t=1 \\
     N_{t-1}^A \exp(r), &amp; \text{for } t&gt;1 
     \end{array}
  \right. .
\end{equation*}\]</span></p>
<p>For simplicity, we’ll assume that there is a 50/50 sex ratio at birth. Recall from <a href="estimation.html">Inference</a> that the probability of a parent-offspring pair is given as</p>
<p><span class="math display">\[\begin{equation*}
   P_{ij} = \frac{E[R_i(b_j)|{\bf z}_i,{\bf z}_j]}{E[R_+(b_j)|{\bf z}_j]},
\end{equation*}\]</span> where</p>
<ul>
<li><span class="math inline">\({\bf z}_i,{\bf z}_j\)</span> are covariate vectors for animals <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> (sex, age, etc.)</li>
<li><span class="math inline">\(R_i(b_j)\)</span> is reproductive output of animal <span class="math inline">\(i\)</span> in <span class="math inline">\(b_j\)</span>, the year of <span class="math inline">\(j\)</span>’s birth.</li>
<li><span class="math inline">\(R_+(b_j)\)</span> is the expected number of offspring in the population for year <span class="math inline">\(b_j\)</span>.</li>
</ul>
<p>According to this specification, <span class="math inline">\(P_{ij}\)</span> is very simple. If we order comparisons so that <span class="math inline">\(i\)</span> is always the older animal, it is simply</p>
<p><span class="math display">\[\begin{equation*}
   P_{ij} = \left\{ 
  \begin{array}{l} 
     2/N_{b_j}^A, &amp; \text{for } a_i(b_j) \ge a_m \\
     0, &amp; \text{otherwise}
     \end{array}
  \right. .
\end{equation*}\]</span></p>
<p>The “2” is there because when we consider sexes individually, and since there is a 50/50 sex ratio, <span class="math inline">\(\phi f/(0.5 \phi f N_{b_j}^A)=2/N_{b_j}^A)\)</span>. The restriction <span class="math inline">\(a_i(b_j) \ge a_m\)</span> simply indicates that there is only probability mass when the age of the prospective parent is greater or equal to the age of sexual maturity (<span class="math inline">\(a_m\)</span>) in the year of <span class="math inline">\(j\)</span>’s birth. We could potentially specify different <span class="math inline">\(a_m\)</span> values for each sex, but we won’t bother in this example. Note that if juveniles are age 0, that the age at maturity according to our life cycle diagram is age 2 (since subadults breed prior to age incrementation into the “adult” class)</p>
<p>Let’s write a little R function to calculate the probability of parent-offspring pairs under this scenario. Note that probabilities are zero if the parent was not sexually mature at the time of <span class="math inline">\(i\)</span>’s birth, or if the parent was sampled (lethally) prior to <span class="math inline">\(i\)</span>’s birth. This function also “expects” that animal <span class="math inline">\(i\)</span> is older than animals <span class="math inline">\(j\)</span>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>get.PO.prob</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>bi</span>,<span class='va'>bj</span>,<span class='va'>di</span>,<span class='va'>am</span>,<span class='va'>Nbj</span><span class='op'>)</span><span class='op'>{</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='op'>(</span><span class='op'>(</span><span class='va'>bj</span><span class='op'>-</span><span class='va'>bi</span><span class='op'>)</span><span class='op'>&gt;=</span><span class='va'>am</span><span class='op'>)</span><span class='op'>*</span><span class='op'>(</span><span class='va'>di</span><span class='op'>&gt;</span><span class='va'>bj</span><span class='op'>)</span><span class='op'>*</span><span class='fl'>2</span><span class='op'>/</span><span class='va'>Nbj</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Half-siblings are a little more difficult, but not too much so. Recall here that the probability of a half sibling pair is</p>
<p><span class="math display">\[\begin{equation*}
  P_{ij} = \sum_{d}  \frac{E[R_d(b_i)]}{E[R_+(b_i)]} \frac{E[R_d(b_j)]}{E[R_+(b_j)]}.
\end{equation*}\]</span></p>
<p>which in our case simplifies to</p>
<p><span class="math display">\[\begin{eqnarray*}
  P_{ij} &amp; = &amp; 0.5 N_{b_i}^A  \frac{\phi f}{0.5 \phi f N_{b_i}^A} \frac{\phi^{b_j - b_i+1}f}{0.5 \phi f N_{b_j}^A} \\
  &amp; = &amp; \frac{2 \phi^{b_j - b_i}}{N_{b_j}^A}.
\end{eqnarray*}\]</span></p>
<p>Let’s write an R function for the probability of half-siblings:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>get.HS.prob</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>bi</span>,<span class='va'>bj</span>,<span class='va'>Nbj</span>,<span class='va'>phi</span><span class='op'>)</span><span class='op'>{</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fl'>2</span><span class='op'>*</span><span class='va'>phi</span><span class='op'>^</span><span class='op'>(</span><span class='va'>bj</span><span class='op'>-</span><span class='va'>bi</span><span class='op'>)</span><span class='op'>/</span><span class='va'>Nbj</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>It would be a huge duplication in computation if we were we use these functions to calculate probabilities for each potential parent-offspring or half-sibling pair. In practice, it may be useful to fill in a lookup table of probabilities prior to computing a pseudo-likelihood. Let’s make functions that do this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>get.PO.lookup.table</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>N</span>,<span class='va'>nyrs</span>,<span class='va'>t_start</span>,<span class='va'>am</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>PO_table</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/array.html'>array</a></span><span class='op'>(</span><span class='fl'>0</span>,dim<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>nyrs</span>,<span class='va'>nyrs</span>,<span class='va'>nyrs</span><span class='op'>)</span><span class='op'>)</span> <span class='co'>#dimensions are parent birth year, parent death year, offspring birth year</span>
  <span class='kw'>for</span><span class='op'>(</span><span class='va'>ibi</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span><span class='op'>{</span>
    <span class='kw'>for</span><span class='op'>(</span><span class='va'>idi</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>ibi</span>,<span class='va'>t_start</span><span class='op'>)</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span><span class='op'>{</span>
      <span class='kw'>for</span><span class='op'>(</span><span class='va'>ibj</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span><span class='op'>{</span>
        <span class='va'>PO_table</span><span class='op'>[</span><span class='va'>ibi</span>,<span class='va'>idi</span>,<span class='va'>ibj</span><span class='op'>]</span><span class='op'>=</span><span class='fu'>get.PO.prob</span><span class='op'>(</span><span class='va'>ibi</span>,<span class='va'>ibj</span>,<span class='va'>idi</span>,<span class='va'>am</span>,<span class='va'>N</span><span class='op'>[</span><span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span>
      <span class='op'>}</span>
    <span class='op'>}</span>
  <span class='op'>}</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>PO_table</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>get.HS.lookup.table</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>N</span>,<span class='va'>phi</span>,<span class='va'>nyrs</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>HS_table</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='va'>nyrs</span>,<span class='va'>nyrs</span><span class='op'>)</span> <span class='co'>#dimensions are ind i's birth year, ind j's birth year </span>
  <span class='kw'>for</span><span class='op'>(</span><span class='va'>ibi</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='va'>nyrs</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span>
    <span class='kw'>for</span><span class='op'>(</span><span class='va'>ibj</span> <span class='kw'>in</span> <span class='va'>ibi</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span><span class='op'>{</span>  <span class='co'>#assuming 'i' is older than 'j'; note no same cohort comparisons</span>
      <span class='va'>HS_table</span><span class='op'>[</span><span class='va'>ibi</span>,<span class='va'>ibj</span><span class='op'>]</span><span class='op'>=</span><span class='fu'>get.HS.prob</span><span class='op'>(</span><span class='va'>ibi</span>,<span class='va'>ibj</span>,<span class='va'>N</span><span class='op'>[</span><span class='va'>ibj</span><span class='op'>]</span>,<span class='va'>phi</span><span class='op'>)</span>
    <span class='op'>}</span>
  <span class='op'>}</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>HS_table</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Note that the inputs to these functions include a vector of adult abundance (<em>N</em>; one value for each year), number of years that we’re modeling abundance (<em>nyrs</em>), the year in which genetic sampling started (<em>t_start</em>), age at maturity (<em>am</em>), and adult annual survival (<em>phi</em>; assumed consant over time).</p>
<p>Okay, so now we have some R functions; how would these be used with real data to write a likelihood function? Let’s start by simulating some real data. We’ll assume a 20 year time series with genetic sampling occuring for the last 10 years of the time series. We’ll set the age of sexual maturity to 3, an initial adult population size of <span class="math inline">\(N_1^A=10,000\)</span> individuals and an <span class="math inline">\(r\)</span> value of 0.01 (translating into an finite intrinsic rate of population increase of <span class="math inline">\(\lambda=1.01\)</span>). We’ll set annual survival to 0.8 for adults, and sample 100 individuals every year.</p>
<p>One approach would be to use individual-based simulation to simulate which individuals survive, mate, and are sampled. By keeping track of pedigrees, one can then determine which sampled animals are related to each other. This is the approach we take in some other examples, but for simplicity we’re going to cheat a little in this example. Specifically, we’re going to specify the ages of individuals sampled in each year and then use our pre-specified probability tables to simulate whether particular matches are related to each other. Note that we don’t recommend doing this when developing your own CKMR code, as mistakes in constructing <span class="math inline">\(P_{ij}\)</span> may be introduced into both the simulation and estimation code, and may thereby go undetected. But for simple illustration this is the approach we’ll take here:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>12345</span><span class='op'>)</span>
<span class='va'>nyrs</span><span class='op'>=</span><span class='fl'>20</span>
<span class='va'>t_start</span> <span class='op'>=</span> <span class='fl'>11</span>
<span class='va'>n_sampled</span><span class='op'>=</span><span class='fl'>100</span>
<span class='va'>n_sampled_tot</span><span class='op'>=</span><span class='va'>n_sampled</span><span class='op'>*</span><span class='op'>(</span><span class='va'>nyrs</span><span class='op'>-</span><span class='va'>t_start</span><span class='op'>+</span><span class='fl'>1</span><span class='op'>)</span>
<span class='va'>r</span><span class='op'>=</span><span class='fl'>0.01</span>
<span class='va'>phi</span><span class='op'>=</span><span class='fl'>0.8</span>
<span class='va'>am</span><span class='op'>=</span><span class='fl'>2</span>  <span class='co'>#age at maturity - here subadults since they survive to adulthood before breeding and having ages incremented</span>
<span class='va'>N_true</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>10000</span>,<span class='va'>nyrs</span><span class='op'>)</span>
<span class='kw'>for</span><span class='op'>(</span><span class='va'>it</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span><span class='va'>N_true</span><span class='op'>[</span><span class='va'>it</span><span class='op'>]</span><span class='op'>=</span><span class='va'>N_true</span><span class='op'>[</span><span class='va'>it</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>*</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>r</span><span class='op'>)</span>
<span class='va'>Sampled</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='va'>n_sampled</span><span class='op'>*</span><span class='op'>(</span><span class='va'>nyrs</span><span class='op'>-</span><span class='va'>t_start</span><span class='op'>+</span><span class='fl'>1</span><span class='op'>)</span>,<span class='fl'>2</span><span class='op'>)</span> <span class='co'>#cols are birth year,death year</span>
<span class='va'>Sampled</span><span class='op'>[</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>t_start</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span>,each<span class='op'>=</span><span class='va'>n_sampled</span><span class='op'>)</span>
<span class='co'>#set birth year proportional to chances of surviving back in time</span>
<span class='va'>S_cum</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>10</span><span class='op'>)</span>
<span class='kw'>for</span><span class='op'>(</span><span class='va'>it</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='fl'>10</span><span class='op'>)</span><span class='va'>S_cum</span><span class='op'>[</span><span class='va'>it</span><span class='op'>]</span> <span class='op'>=</span> <span class='va'>S_cum</span><span class='op'>[</span><span class='va'>it</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>*</span><span class='va'>phi</span>
<span class='va'>Age_death</span><span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/stats/Multinom.html'>rmultinom</a></span><span class='op'>(</span><span class='va'>nyrs</span><span class='op'>*</span><span class='va'>n_sampled</span>,<span class='fl'>1</span>,<span class='va'>S_cum</span><span class='op'>)</span>
<span class='kw'>for</span><span class='op'>(</span><span class='va'>isamp</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>Sampled</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>isamp</span>,<span class='fl'>1</span><span class='op'>]</span><span class='op'>=</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>isamp</span>,<span class='fl'>2</span><span class='op'>]</span><span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>Age_death</span><span class='op'>[</span>,<span class='va'>isamp</span><span class='op'>]</span><span class='op'>==</span><span class='fl'>1</span><span class='op'>)</span><span class='op'>+</span><span class='fl'>1</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Okay, so now we have a matrix, <em>Sampled</em>, that includes both year of birth (first column) and year of death (2nd column), which is biased towards younger animals because few animals survive to old age. Now we’ll use our probability tables to determine which animals are related. Note that there are 1000 sampled animals, so <span class="math inline">\({1000 \choose 2} = 499,500\)</span> possible comparisons for each type of kinship pair (POP, HSP), which is quite a few to do individually! While we <em>could</em> do this type of brute force loop, certainly we shoud be able to do better (especially when eventually analyzing our “data”). In statistics, large problems like this are often tackled by grouping data into sufficient statistics, which yield the exact same inference as the ungrouped data, but at greater efficiency. For parent-offspring pairs, the probabilities associated with each comparison will be the same depending on parent’s birth date, parent’s death date, and offspring’s birth date, let’s group comparisons that way too. Similarly, for half-siblings, let’s group comparisons by birth dates.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>n_comp_bidibj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/array.html'>array</a></span><span class='op'>(</span><span class='fl'>0</span>, dim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>nyrs</span>, <span class='va'>nyrs</span>, <span class='va'>nyrs</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>n_comp_bibj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>nyrs</span>, <span class='va'>nyrs</span><span class='op'>)</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='va'>n_sampled_tot</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>j</span> <span class='kw'>in</span> <span class='op'>(</span><span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='va'>n_sampled_tot</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='kw'>if</span> <span class='op'>(</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;</span> <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>n_comp_bidibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>2</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bidibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>2</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>1</span>
      <span class='va'>n_comp_bibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>1</span>
    <span class='op'>}</span>
    <span class='kw'>if</span> <span class='op'>(</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&gt;</span> <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>n_comp_bidibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>2</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bidibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>2</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>1</span>
      <span class='va'>n_comp_bibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bibj</span><span class='op'>[</span><span class='va'>Sampled</span><span class='op'>[</span><span class='va'>j</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>Sampled</span><span class='op'>[</span><span class='va'>i</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='fl'>1</span>
    <span class='op'>}</span>
  <span class='op'>}</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Note that we’ve omitted comparisons where birth dates are the same, which is a useful strategy for avoiding potential complications with dependent fates, and that <em>i</em> always designates the older animal. Note also that in ``large" problems, we might want to do this step in a lower level language like C++ or TMB!</p>
<p>Now that we’ve summarized the number of comparisons in the same format as probabilities, we’re in a position of simulating some CKMR data. We’ll just use a simple binomial model to simulate matches:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>n_match_PO_bidibj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/array.html'>array</a></span><span class='op'>(</span><span class='fl'>0</span>, dim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>nyrs</span>, <span class='va'>nyrs</span>, <span class='va'>nyrs</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>n_match_HS_bibj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>nyrs</span>, <span class='va'>nyrs</span><span class='op'>)</span>
<span class='va'>PO_table</span> <span class='op'>&lt;-</span> <span class='fu'>get.PO.lookup.table</span><span class='op'>(</span>N <span class='op'>=</span> <span class='va'>N_true</span>, <span class='va'>nyrs</span>, <span class='va'>t_start</span>, <span class='va'>am</span><span class='op'>)</span>
<span class='va'>HS_table</span> <span class='op'>&lt;-</span> <span class='fu'>get.HS.lookup.table</span><span class='op'>(</span>N <span class='op'>=</span> <span class='va'>N_true</span>, <span class='va'>phi</span>, <span class='va'>nyrs</span><span class='op'>)</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>ibi</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='va'>nyrs</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>ibj</span> <span class='kw'>in</span> <span class='op'>(</span><span class='va'>ibi</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>n_match_HS_bibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>rbinom</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>n_comp_bibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span>, <span class='va'>HS_table</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span>
    <span class='co'># n_match_HS_bibj[ibi,ibj]=n_comp_bibj[ibi,ibj]*HS_table[ibi,ibj] #expected value</span>
    <span class='kw'>for</span> <span class='op'>(</span><span class='va'>idi</span> <span class='kw'>in</span> <span class='va'>ibj</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>n_match_PO_bidibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>rbinom</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>n_comp_bidibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span>, <span class='va'>PO_table</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span>
      <span class='co'># n_match_PO_bidibj[ibi,idi,ibj]=n_comp_bidibj[ibi,idi,ibj]*PO_table[ibi,idi,ibj] note: expected values are useful for debugging.  You should get back truth (within a decimal place) if the likelihood is coded correctly</span>
    <span class='op'>}</span>
  <span class='op'>}</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Let’s take a look at the total number of comparisons that were made, as well as the number of POPs and HSPs that we simulated</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n_comp_bibj</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 462758</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n_match_PO_bidibj</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 16</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>n_match_HS_bibj</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 31</code></pre>
</div>
<p>Note that the number of comparisons was very high, but we still only obtained 16 parent-offspring pairs and 31 half-sibling pairs. Note this is under the ``rule of thumb" of 50 matches recommended for CKMR analysis, but we’re close!</p>
<p>Okay, so now we have some data. Let’s fit a close-kin model to them and see if we can recover the abundance and survival parameters used to generate the data. We’ll do this first in R, using the <span class="math inline">\(optimx\)</span> function in R to minimize the negative log pseudo-likelihood; then we’ll then run it through TMB to compare performance. As usual, we’ll use link functions so that parameters can be optimized on <span class="math inline">\((-\infty,\infty)\)</span>. We’ll use a binomial likelihood function, but instead of using, e.g., <span class="math inline">\(dbinom\)</span>, we’ll just use the kernel of the binomial pdf (the part of the log likelihood that includes parameters). So, e.g., for the binomial model <span class="math display">\[\begin{equation*}
  {n \choose k}p^k(1-p)^{n-k},
\end{equation*}\]</span> we’ll take logs and just pick out the kernel <span class="math display">\[\begin{equation*}
  k \log(p) + (n-k) \log(1-p).
\end{equation*}\]</span> One computational issue that can arise with this approach is that <span class="math inline">\(p\)</span> can go to zero within optimization which results in a numerical error since <span class="math inline">\(\log(0)\)</span> is undefined. So, we’ll also define a function to calculate <span class="math inline">\(k \log(p)\)</span> that avoids this error. We’ll also restrict <span class="math inline">\(\lambda\)</span>, the finite rate of population growth to <span class="math inline">\((0.9,1.0)\)</span> to prevent numerical errors (such as the optimizer exploring solutions where the population crashes to near zero).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>n.log.p</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>n</span>, <span class='va'>p</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>n</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>p</span> <span class='op'>+</span> <span class='fl'>1.0</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>p</span> <span class='op'>==</span> <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>nll.fun</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>Pars</span>, <span class='va'>Data</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>phi</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>Pars</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>
  <span class='va'>N</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>Data</span><span class='op'>$</span><span class='va'>nyrs</span><span class='op'>)</span>
  <span class='va'>N</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Pars</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>100</span> <span class='co'># the '100 is to help keep abundance &gt; 2 during optimization</span>
  <span class='va'>lambda</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>Pars</span><span class='op'>[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>/</span> <span class='fl'>5</span> <span class='op'>+</span> <span class='fl'>0.9</span> <span class='co'># restrict to (0.9,1.1)</span>
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>it</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='va'>Data</span><span class='op'>$</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='va'>N</span><span class='op'>[</span><span class='va'>it</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>N</span><span class='op'>[</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>]</span> <span class='op'>*</span> <span class='va'>lambda</span>
  <span class='va'>logl</span> <span class='op'>&lt;-</span> <span class='fl'>0</span>
  <span class='va'>P_po</span> <span class='op'>&lt;-</span> <span class='fu'>get.PO.lookup.table</span><span class='op'>(</span><span class='va'>N</span>, <span class='va'>Data</span><span class='op'>$</span><span class='va'>nyrs</span>, <span class='va'>Data</span><span class='op'>$</span><span class='va'>t_start</span>, <span class='va'>Data</span><span class='op'>$</span><span class='va'>am</span><span class='op'>)</span>
  <span class='va'>P_hs</span> <span class='op'>&lt;-</span> <span class='fu'>get.HS.lookup.table</span><span class='op'>(</span><span class='va'>N</span>, <span class='va'>phi</span>, <span class='va'>Data</span><span class='op'>$</span><span class='va'>nyrs</span><span class='op'>)</span>
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>ibi</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='va'>nyrs</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='kw'>for</span> <span class='op'>(</span><span class='va'>ibj</span> <span class='kw'>in</span> <span class='op'>(</span><span class='va'>ibi</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='va'>Data</span><span class='op'>$</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>logl</span> <span class='op'>&lt;-</span> <span class='va'>logl</span> <span class='op'>+</span> <span class='fu'>n.log.p</span><span class='op'>(</span><span class='va'>Data</span><span class='op'>$</span><span class='va'>n_match_HS_bibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span>, <span class='va'>P_hs</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>Data</span><span class='op'>$</span><span class='va'>n_no_match_HS</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>P_hs</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span> <span class='co'># HSPs</span>
      <span class='co'># logl = logl + dpois(Data$n_match_HS_bibj[ibi,ibj],(Data$n_match_HS_bibj[ibi,ibj]+Data$n_no_match_HS[ibi,ibj])*P_hs[ibi,ibj],log=T)  #alternative Poisson approximation</span>
      <span class='kw'>for</span> <span class='op'>(</span><span class='va'>idi</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>ibi</span>, <span class='va'>Data</span><span class='op'>$</span><span class='va'>t_start</span><span class='op'>)</span><span class='op'>:</span><span class='va'>Data</span><span class='op'>$</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='va'>logl</span> <span class='op'>&lt;-</span> <span class='va'>logl</span> <span class='op'>+</span> <span class='fu'>n.log.p</span><span class='op'>(</span><span class='va'>Data</span><span class='op'>$</span><span class='va'>n_match_PO_bidibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span>, <span class='va'>P_po</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>Data</span><span class='op'>$</span><span class='va'>n_no_match_PO</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>P_po</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span> <span class='co'># POPs</span>
      <span class='op'>}</span>
    <span class='op'>}</span>
  <span class='op'>}</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>logl</span><span class='op'>)</span>
<span class='op'>}</span>


<span class='va'>n_no_match_HS</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bibj</span> <span class='op'>-</span> <span class='va'>n_match_HS_bibj</span>
<span class='va'>n_no_match_PO</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bidibj</span> <span class='op'>-</span> <span class='va'>n_match_PO_bidibj</span>
<span class='va'>Data</span> <span class='op'>&lt;-</span> <span class='va'>Data_orig</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>n_match_HS_bibj <span class='op'>=</span> <span class='va'>n_match_HS_bibj</span>, n_no_match_HS <span class='op'>=</span> <span class='va'>n_no_match_HS</span>, n_match_PO_bidibj <span class='op'>=</span> <span class='va'>n_match_PO_bidibj</span>, n_no_match_PO <span class='op'>=</span> <span class='va'>n_no_match_PO</span>, nyrs <span class='op'>=</span> <span class='va'>nyrs</span>, t_start <span class='op'>=</span> <span class='va'>t_start</span>, am <span class='op'>=</span> <span class='va'>am</span><span class='op'>)</span>
<span class='va'>Par_start</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'>logit</span><span class='op'>(</span><span class='va'>phi</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='fl'>10000</span><span class='op'>)</span>, <span class='fl'>0.0</span><span class='op'>)</span>
<span class='va'>Start_time</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>Opt</span> <span class='op'>&lt;-</span> <span class='fu'>optimx</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/optimx/man/optimx.html'>optimx</a></span><span class='op'>(</span>par <span class='op'>=</span> <span class='va'>Par_start</span>, fn <span class='op'>=</span> <span class='va'>nll.fun</span>, hessian <span class='op'>=</span> <span class='cn'>TRUE</span>, method <span class='op'>=</span> <span class='st'>"BFGS"</span>, Data <span class='op'>=</span> <span class='va'>Data</span><span class='op'>)</span>
<span class='va'>End_time</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>Opt</span><span class='op'>$</span><span class='va'>convcode</span>
</code></pre>
</div>
<pre><code>[1] 0</code></pre>
</div>
<p>Okay, it looks like the optimizer has minimized the log pseudo-likelihood successfully in a time of 1.13231182098389 seconds - extremely fast for a CKMR model, but then again it’s not very complex. Let’s examine our results. First, annual survival is estimated as</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p1</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 0.8271791</code></pre>
</div>
<p>compared to a true value of 0.8. The standard error can be calculated using the delta method <span class="citation" data-cites="Dorfman1938">[<a href="#ref-Dorfman1938" role="doc-biblioref">3</a>]</span>, where we use the Hessian of the optimization to calculate the variance-covariance matrix of parameters on untransformed space:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>VC_trans</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/solve.html'>solve</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/attr.html'>attr</a></span><span class='op'>(</span><span class='va'>Opt</span>, <span class='st'>"details"</span><span class='op'>)</span><span class='op'>[</span><span class='st'>"BFGS"</span>, <span class='st'>"nhatend"</span><span class='op'>]</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>
<span class='va'>D</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>3</span><span class='op'>)</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p1</span><span class='op'>)</span> <span class='op'>/</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span>, <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p2</span><span class='op'>)</span>, <span class='fl'>0.2</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p3</span><span class='op'>)</span> <span class='op'>/</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p3</span><span class='op'>)</span><span class='op'>)</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span> <span class='co'># derivatives of transformations</span>
<span class='va'>VC_real</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='va'>D</span><span class='op'>)</span> <span class='op'>%*%</span> <span class='va'>VC_trans</span> <span class='op'>%*%</span> <span class='va'>D</span>
<span class='va'>SE_survival</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='va'>VC_real</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>
<span class='va'>SE_survival</span>
</code></pre>
</div>
<pre><code>[1] 0.05344457</code></pre>
</div>
<p>As an aside, I’ve found one of the most accessible introductions to the delta method to be in “A Gentle Introduction to Program MARK,” <a href="http://www.phidot.org/software/mark/docs/book/pdf/app_2.pdf">Appendix B</a> . The following plot shows estimated abundance (and trend) compared to true abundance, together with approximate 95% [symmetric] confidence intervals</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>N_est</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p2</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>100</span>, <span class='va'>nyrs</span><span class='op'>)</span>
<span class='va'>lambda_est</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p3</span><span class='op'>)</span> <span class='op'>/</span> <span class='fl'>5</span> <span class='op'>+</span> <span class='fl'>0.9</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>it</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='va'>N_est</span><span class='op'>[</span><span class='va'>it</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>N_est</span><span class='op'>[</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>]</span> <span class='op'>*</span> <span class='va'>lambda_est</span>
<span class='va'>D_Nlam</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>2</span>, <span class='va'>nyrs</span><span class='op'>)</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>it</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='va'>D_Nlam</span><span class='op'>[</span><span class='fl'>1</span>, <span class='va'>it</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>lambda_est</span><span class='op'>^</span><span class='op'>(</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span> <span class='co'># derivative of N0*lambda^(it-1) wrt N0</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>it</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='va'>D_Nlam</span><span class='op'>[</span><span class='fl'>2</span>, <span class='va'>it</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>lambda_est</span><span class='op'>^</span><span class='op'>(</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>N_est</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>100</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>lambda_est</span><span class='op'>^</span><span class='op'>(</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>2</span><span class='op'>)</span> <span class='co'># derivative of N0*lambda^(it-1) wrt lambda</span>
<span class='va'>VC_N</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='va'>D_Nlam</span><span class='op'>)</span> <span class='op'>%*%</span> <span class='va'>VC_real</span><span class='op'>[</span><span class='op'>-</span><span class='fl'>1</span>, <span class='op'>-</span><span class='fl'>1</span><span class='op'>]</span> <span class='op'>%*%</span> <span class='va'>D_Nlam</span>
<span class='va'>SE_N</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='va'>VC_N</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>N_lower</span> <span class='op'>&lt;-</span> <span class='va'>N_est</span> <span class='op'>-</span> <span class='fl'>1.96</span> <span class='op'>*</span> <span class='va'>SE_N</span>
<span class='va'>N_upper</span> <span class='op'>&lt;-</span> <span class='va'>N_est</span> <span class='op'>+</span> <span class='fl'>1.96</span> <span class='op'>*</span> <span class='va'>SE_N</span>
<span class='va'>plot_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>Year <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>)</span>, N <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>N_est</span>, <span class='va'>N_true</span><span class='op'>)</span>, Type <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"Estimated"</span>, <span class='va'>nyrs</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"True"</span>, <span class='va'>nyrs</span><span class='op'>)</span><span class='op'>)</span>, N025 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>N_lower</span>, <span class='va'>N_true</span><span class='op'>)</span>, N975 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>N_upper</span>, <span class='va'>N_true</span><span class='op'>)</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ggplot2.tidyverse.org'>ggplot2</a></span><span class='op'>)</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>plot_df</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>Year</span>, y <span class='op'>=</span> <span class='va'>N</span>, color <span class='op'>=</span> <span class='va'>Type</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_ribbon.html'>geom_ribbon</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>ymin <span class='op'>=</span> <span class='va'>N025</span>, ymax <span class='op'>=</span> <span class='va'>N975</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.1</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="adults_the_same_files/figure-html5/abund-res-1.png" width="624" /></p>
</div>
<p>There are a couple of points worth making at this point. First, we have obtained highly reasonable estimates of survival and abundance. Even though we have estimated a slightly declining population instead of a slightly increasing population, true values are all included within relatively large confidence intervals. Second, we see a pattern common to most CKMR time series estimates of abundance: <span class="math inline">\(\hat{N}_t\)</span> is the most precise towards the beginning and middle of the sampling period (recall sampling occurred in years 11 to 20). It is least precise at the beginning and end. Thus CKMR has some limitations in monitoring plans when the focus is on implementing management actions in real time as that is precisely when there is some of the greatest uncertainty. It’s pretty neat that we can recover past dynamics by sampling in the present, however.</p>
<p>For fun (and to assess the overall performance of this model over and above a single realization), let’s repeat estimation a number of times and keep track of estimator performance. We’ll focus on <span class="math inline">\(\phi\)</span>, <span class="math inline">\(\lambda\)</span>, and <span class="math inline">\(\bar{\hat{N}}_{10:15}\)</span>, which will be the average estimated abundance in years 10 to 15.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>nsim</span> <span class='op'>&lt;-</span> <span class='fl'>100</span>
<span class='va'>N_avg</span> <span class='op'>&lt;-</span> <span class='va'>Phi_est</span> <span class='op'>&lt;-</span> <span class='va'>Lambda_est</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>nsim</span><span class='op'>)</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>isim</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>nsim</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>n_match_PO_bidibj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/array.html'>array</a></span><span class='op'>(</span><span class='fl'>0</span>, dim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>nyrs</span>, <span class='va'>nyrs</span>, <span class='va'>nyrs</span><span class='op'>)</span><span class='op'>)</span>
  <span class='va'>n_match_HS_bibj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>nyrs</span>, <span class='va'>nyrs</span><span class='op'>)</span>
  <span class='va'>PO_table</span> <span class='op'>&lt;-</span> <span class='fu'>get.PO.lookup.table</span><span class='op'>(</span>N <span class='op'>=</span> <span class='va'>N_true</span>, <span class='va'>nyrs</span>, <span class='va'>t_start</span>, <span class='va'>am</span><span class='op'>)</span>
  <span class='va'>HS_table</span> <span class='op'>&lt;-</span> <span class='fu'>get.HS.lookup.table</span><span class='op'>(</span>N <span class='op'>=</span> <span class='va'>N_true</span>, <span class='va'>phi</span>, <span class='va'>nyrs</span><span class='op'>)</span>
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>ibi</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='va'>nyrs</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='kw'>for</span> <span class='op'>(</span><span class='va'>ibj</span> <span class='kw'>in</span> <span class='op'>(</span><span class='va'>ibi</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>n_match_HS_bibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>rbinom</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>n_comp_bibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span>, <span class='va'>HS_table</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span>
      <span class='co'># n_match_HS_bibj[ibi,ibj]=n_comp_bibj[ibi,ibj]*HS_table[ibi,ibj] #expected value</span>
      <span class='kw'>for</span> <span class='op'>(</span><span class='va'>idi</span> <span class='kw'>in</span> <span class='va'>ibj</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='va'>n_match_PO_bidibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>rbinom</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>n_comp_bidibj</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span>, <span class='va'>PO_table</span><span class='op'>[</span><span class='va'>ibi</span>, <span class='va'>idi</span>, <span class='va'>ibj</span><span class='op'>]</span><span class='op'>)</span>
      <span class='op'>}</span>
    <span class='op'>}</span>
  <span class='op'>}</span>
  <span class='va'>n_no_match_HS</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bibj</span> <span class='op'>-</span> <span class='va'>n_match_HS_bibj</span>
  <span class='va'>n_no_match_PO</span> <span class='op'>&lt;-</span> <span class='va'>n_comp_bidibj</span> <span class='op'>-</span> <span class='va'>n_match_PO_bidibj</span>
  <span class='va'>Data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>n_match_HS_bibj <span class='op'>=</span> <span class='va'>n_match_HS_bibj</span>, n_no_match_HS <span class='op'>=</span> <span class='va'>n_no_match_HS</span>, n_match_PO_bidibj <span class='op'>=</span> <span class='va'>n_match_PO_bidibj</span>, n_no_match_PO <span class='op'>=</span> <span class='va'>n_no_match_PO</span>, nyrs <span class='op'>=</span> <span class='va'>nyrs</span>, t_start <span class='op'>=</span> <span class='va'>t_start</span>, am <span class='op'>=</span> <span class='va'>am</span><span class='op'>)</span>
  <span class='va'>Par_start</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'>logit</span><span class='op'>(</span><span class='va'>phi</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='fl'>10000</span><span class='op'>)</span>, <span class='fl'>0.0</span><span class='op'>)</span>
  <span class='va'>Opt</span> <span class='op'>&lt;-</span> <span class='fu'>optimx</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/optimx/man/optimx.html'>optimx</a></span><span class='op'>(</span>par <span class='op'>=</span> <span class='va'>Par_start</span>, fn <span class='op'>=</span> <span class='va'>nll.fun</span>, hessian <span class='op'>=</span> <span class='cn'>TRUE</span>, method <span class='op'>=</span> <span class='st'>"BFGS"</span>, Data <span class='op'>=</span> <span class='va'>Data</span><span class='op'>)</span>
  <span class='va'>Phi_est</span><span class='op'>[</span><span class='va'>isim</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p1</span><span class='op'>)</span>
  <span class='va'>Lambda_est</span><span class='op'>[</span><span class='va'>isim</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fl'>0.9</span> <span class='op'>+</span> <span class='fl'>0.2</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p3</span><span class='op'>)</span>
  <span class='va'>N_est</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>Opt</span><span class='op'>$</span><span class='va'>p2</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>100</span>, <span class='va'>nyrs</span><span class='op'>)</span>
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>it</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='va'>nyrs</span><span class='op'>)</span> <span class='va'>N_est</span><span class='op'>[</span><span class='va'>it</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>N_est</span><span class='op'>[</span><span class='va'>it</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>]</span> <span class='op'>*</span> <span class='va'>Lambda_est</span><span class='op'>[</span><span class='va'>isim</span><span class='op'>]</span>
  <span class='va'>N_avg</span><span class='op'>[</span><span class='va'>isim</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>N_est</span><span class='op'>[</span><span class='fl'>10</span><span class='op'>:</span><span class='fl'>15</span><span class='op'>]</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Let’s see how we did over the 100 simulations in recovering true values:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>3</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/hist.html'>hist</a></span><span class='op'>(</span><span class='va'>Phi_est</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/abline.html'>abline</a></span><span class='op'>(</span>v <span class='op'>=</span> <span class='va'>phi</span>, col <span class='op'>=</span> <span class='st'>"blue"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/hist.html'>hist</a></span><span class='op'>(</span><span class='va'>N_avg</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/abline.html'>abline</a></span><span class='op'>(</span>v <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>N_true</span><span class='op'>[</span><span class='fl'>10</span><span class='op'>:</span><span class='fl'>15</span><span class='op'>]</span><span class='op'>)</span>, col <span class='op'>=</span> <span class='st'>"blue"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/hist.html'>hist</a></span><span class='op'>(</span><span class='va'>Lambda_est</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/abline.html'>abline</a></span><span class='op'>(</span>v <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>r</span><span class='op'>)</span>, col <span class='op'>=</span> <span class='st'>"blue"</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="adults_the_same_files/figure-html5/plot-sim-1.png" width="624" /></p>
</div>
<p>Here, I’ve plotted a histogram of estimates over each of the 100 simulation runs, and placed a blue vertical line where the true value is. It looks like we’re doing a good job at recovering annual survival using half-sib data (though somewhat imprecise), as well as absolute abundance for the period where there is the most information (beginning-middle of our sampling efforts). However, our estimates of <span class="math inline">\(\lambda\)</span> are pretty terrible. For a population that is slightly increasing, there is a depressingly large proportion of simulation replicates that indicate either a sharply increasing or sharply decreasing population. This is a case where simulation might help us establish a reasonable level of model complexity. In particular, if confronted with a population with similar life history and sample sizes, I would most likely fit a constrained model with <span class="math inline">\(\lambda=1.0\)</span> to at least get a reasonable estimate of mean population size without worrying managers with estimates of trend that might be off.</p>
<p>Although computational speed is highly acceptable in this example (<span class="math inline">\(&lt;1\)</span> second), one last thing I want to do is to fit the same model in TMB. This basic example will help set the stage for other, more complex models where we will need the benefits of a lower level language and autodifferentiation to optimize pseudo-likelihoods that carry a higher computational burden. Users will need to have the <a href="https://github.com/kaskr/adcomp/wiki/Download">TMB</a> package installed (together with RTools) to run this code. Each TMB model is coded in a templated C++ language and saved to a file with a .cpp extension. Although the language isn’t too different from R, there are few key differences. For instance, one has to be a bit more careful about declaring what type of variable one is working with (e.g., integer, double precision, matrices, etc.) and it’s dimensions. One difference that often causes issues is that vectors start with index 0 (instead of 1) - and going over vector or array bounds often results in a generic error that causes R to crash. Debugging capabilities are relatively limited at the moment in Windows, but there are reportedly better tools for Mac OS and Linux. Okay, enough with the disclaimers: let’s see an example.</p>
<p>I’ve saved the .cpp file for the likelihood calculation <a href="./TMB_cpp/adults_the_same.cpp">here</a>. We’ll need to use R to compile this .cpp file, set it up to pass our data and parameters to it, and then optimize the function (we’ll do this using <em>nlminb</em> in R):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/kaskr/adcomp/wiki'>TMB</a></span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/getwd.html'>getwd</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;C:/Users/paul.conn/git/dummy_website&quot;</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>TmbFile</span> <span class='op'>&lt;-</span> <span class='st'>"./TMB_cpp/adults_the_same.cpp"</span>
<span class='fu'><a href='https://rdrr.io/pkg/TMB/man/compile.html'>compile</a></span><span class='op'>(</span><span class='va'>TmbFile</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Note: Using Makevars in C:/Users/paul.conn/Work/.R/Makevars </code></pre>
<pre><code>[1] 0</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>TmbExec</span> <span class='op'>&lt;-</span> <span class='st'>"./TMB_cpp/adults_the_same"</span>
<span class='fu'><a href='https://rdrr.io/r/base/dynload.html'>dyn.load</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/TMB/man/dynlib.html'>dynlib</a></span><span class='op'>(</span><span class='va'>TmbExec</span><span class='op'>)</span><span class='op'>)</span>


<span class='va'>Data</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='st'>"nyrs"</span> <span class='op'>=</span> <span class='va'>nyrs</span>, <span class='st'>"t_start"</span> <span class='op'>=</span> <span class='va'>t_start</span> <span class='op'>-</span> <span class='fl'>1</span>, <span class='st'>"am"</span> <span class='op'>=</span> <span class='va'>am</span>, <span class='st'>"n_match_HS_bibj"</span> <span class='op'>=</span> <span class='va'>n_match_HS_bibj</span>, <span class='st'>"n_comp_HS_bibj"</span> <span class='op'>=</span> <span class='va'>n_comp_bibj</span>, <span class='st'>"n_match_PO_bidibj"</span> <span class='op'>=</span> <span class='va'>n_match_PO_bidibj</span>, <span class='st'>"n_comp_PO_bidibj"</span> <span class='op'>=</span> <span class='va'>n_comp_bidibj</span><span class='op'>)</span> <span class='co'># recall vectors in C++ start at zero so t_start-1</span>

<span class='va'>Params</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='st'>"phi_logit"</span> <span class='op'>=</span> <span class='fu'>logit</span><span class='op'>(</span><span class='fl'>0.5</span><span class='op'>)</span>, <span class='st'>"N0_trans"</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='fl'>5000</span><span class='op'>)</span>, <span class='st'>"lambda_trans"</span> <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='co'># intial param values</span>

<span class='va'>Map</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span> <span class='co'># specify fixed parameter values</span>
<span class='va'>Random</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span> <span class='co'># specify which params are random effects to be integrated out with Laplace Approx</span>

<span class='va'>Obj</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/TMB/man/MakeADFun.html'>MakeADFun</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>Data</span>, parameters <span class='op'>=</span> <span class='va'>Params</span>, random <span class='op'>=</span> <span class='va'>Random</span>, map <span class='op'>=</span> <span class='va'>Map</span>, hessian <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>

<span class='co'># Minimize negative log likelihood and time it</span>
<span class='va'>Start_time</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>Opt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/nlminb.html'>nlminb</a></span><span class='op'>(</span>start <span class='op'>=</span> <span class='va'>Params</span>, objective <span class='op'>=</span> <span class='va'>Obj</span><span class='op'>$</span><span class='va'>fn</span>, gradient <span class='op'>=</span> <span class='va'>Obj</span><span class='op'>$</span><span class='va'>gr</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>outer mgc:  32.34748 
outer mgc:  6.993078 
outer mgc:  6.282756 
outer mgc:  1.067205 
outer mgc:  1.981495 
outer mgc:  2.583811 
outer mgc:  0.5611916 
outer mgc:  1.230741 
outer mgc:  1.76202 
outer mgc:  1.182779 
outer mgc:  0.6063267 
outer mgc:  0.5483069 
outer mgc:  0.304848 
outer mgc:  0.1924532 
outer mgc:  0.1501858 
outer mgc:  0.004058521 
outer mgc:  0.01420098 
outer mgc:  0.0005558604 
outer mgc:  1.578735e-05 </code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>End_time</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Sys.time.html'>Sys.time</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>SD_report</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/TMB/man/sdreport.html'>sdreport</a></span><span class='op'>(</span><span class='va'>Obj</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>outer mgc:  1.578735e-05 
outer mgc:  0.01871774 
outer mgc:  0.01871993 
outer mgc:  0.05358611 
outer mgc:  0.05363377 
outer mgc:  0.01241441 
outer mgc:  0.01242596 
outer mgc:  18781.73 </code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>N_est_TMB</span> <span class='op'>&lt;-</span> <span class='va'>SD_report</span><span class='op'>$</span><span class='va'>value</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>SD_report</span><span class='op'>$</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>==</span> <span class='st'>"N"</span><span class='op'>)</span><span class='op'>]</span>

<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>N_est_TMB</span>, ylab <span class='op'>=</span> <span class='st'>"N"</span>, xlab <span class='op'>=</span> <span class='st'>"Year"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/lines.html'>lines</a></span><span class='op'>(</span><span class='va'>N_est</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="adults_the_same_files/figure-html5/tmb-1.png" width="624" /></p>
</div>
<p>Here, points give abundance estimates from TMB, while the line gives estimates from R. So, we’ve managed to fit the exact same model and get the exact same estimates in TMB as R (note this was with the last simulated dataset rather than the original dataset). But the important point is that it took 0.00299191474914551 seconds to minimize the negative log-pseudo-likelihood with autodifferentiation via TMB, which was <span class="math inline">\(200\)</span> times faster than doing the minimization in R.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<div id="refs" class="references csl-bib-body" role="doc-bibliography">
<div id="ref-Caswell2001" class="csl-entry" role="doc-biblioentry">
1. Caswell H. Matrix population models, 2nd edition. Sunderland, MA: Sinauer; 2001.
</div>
<div id="ref-KendallEtAl2019" class="csl-entry" role="doc-biblioentry">
2. Kendall BE, Fujiwara M, Diaz-Lopez J, Schneider S, Voigt J, Wiesner S. Persistent problems in the construction of matrix population models. Ecological modelling. 2019;406:33–43.
</div>
<div id="ref-Dorfman1938" class="csl-entry" role="doc-biblioentry">
3. Dorfman R. A note on the delta-method for finding variance formulae. The Biometric Bulletin. 1938;1:129–37.
</div>
</div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="references">References</h3>
<div id="references-listing"></div>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
